<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syyd Chess Pro</title>
    
    <!-- Kütüphaneler -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root { --bg: #161512; --panel: #262421; --accent: #45a049; --white: #dee3e6; --black: #8ca2ad; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        
        .main-layout { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        #board { width: 500px; max-width: 90vw; border-radius: 4px; box-shadow: 0 10px 50px rgba(0,0,0,0.7); }

        /* Yan Panel */
        .side-panel { width: 300px; background: var(--panel); padding: 20px; border-radius: 8px; display: flex; flex-direction: column; gap: 15px; }
        .status-badge { background: #312e2b; padding: 10px; border-radius: 4px; border-left: 4px solid var(--accent); font-size: 0.9rem; }
        
        /* Koltuk Seçimi */
        .seats { display: flex; gap: 10px; }
        .seat { flex: 1; padding: 15px; border: 2px solid #3d3a37; border-radius: 6px; text-align: center; cursor: pointer; transition: 0.3s; }
        .seat.active { border-color: var(--accent); background: rgba(69, 160, 73, 0.1); }
        .seat.occupied { opacity: 0.5; cursor: not-allowed; }

        button { background: #3d3a37; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #4d4a46; }
        button.primary { background: var(--accent); }
        
        .timer { font-family: monospace; font-size: 2rem; text-align: center; background: #1a1917; padding: 10px; border-radius: 4px; margin: 10px 0; }
        
        /* Lichess Kare Renkleri */
        .white-1e1d7 { background-color: var(--white) !important; }
        .black-3b838 { background-color: var(--black) !important; }
        
        #room-link { font-size: 0.7rem; color: #888; word-break: break-all; margin-top: 10px; }
    </style>
</head>
<body>

<div class="main-layout">
    <div id="board"></div>

    <div class="side-panel">
        <div id="game-info">
            <h2 style="margin:0 0 10px 0;">Syyd Chess Pro</h2>
            <div class="status-badge" id="game-status">Bağlanıyor...</div>
        </div>

        <div class="timer" id="game-timer">05:00</div>

        <div id="setup-section">
            <label>Oyun Modu:</label>
            <select id="mode-select" style="width:100%; padding:8px; background:#3d3a37; color:white; border:none;">
                <option value="ai">Yapay Zekaya Karşı (Stockfish)</option>
                <option value="friend">Arkadaşınla Oyna (Online)</option>
            </select>

            <div id="ai-levels" style="margin-top:10px;">
                <label>AI Seviyesi (1-10):</label>
                <input type="range" id="ai-level" min="1" max="10" value="3" style="width:100%;">
            </div>

            <div id="seat-selection" style="margin-top:15px;">
                <label>Koltuk Seç:</label>
                <div class="seats">
                    <div class="seat" id="seat-white" onclick="selectSeat('w')">⚪ BEYAZ</div>
                    <div class="seat" id="seat-black" onclick="selectSeat('b')">⚫ SİYAH</div>
                </div>
            </div>

            <button class="primary" id="start-btn" onclick="initGame()" style="margin-top:20px; width:100%;">HAZIR & BAŞLAT</button>
            <div id="room-link"></div>
        </div>
        
        <button onclick="location.reload()" style="font-size: 0.8rem; opacity: 0.6;">Sıfırla</button>
    </div>
</div>

<!-- Ses Efektleri -->
<audio id="move-sound" src="https://images.chesscomfiles.com/chess-themes/sounds/_standard/move-self.mp3"></audio>

<script>
    var board = null;
    var game = new Chess();
    var peer = null;
    var conn = null;
    var myRole = null; // 'w' or 'b'
    var isAIGame = true;
    var moveSound = document.getElementById('move-sound');

    // PeerJS Kurulumu (Online için)
    const roomId = new URLSearchParams(window.location.search).get('room') || Math.random().toString(36).substring(7);
    const isGuest = new URLSearchParams(window.location.search).has('room');

    function initPeer() {
        peer = new Peer('syyd-' + roomId);
        
        peer.on('open', (id) => {
            $('#game-status').text(isGuest ? 'Odaya bağlanıldı!' : 'Oda kuruldu. Arkadaşını bekle.');
            if(!isGuest) {
                const link = window.location.origin + window.location.pathname + '?room=' + roomId;
                $('#room-link').text('Paylaşım Linki: ' + link);
            }
        });

        peer.on('connection', (c) => {
            conn = c;
            setupConn();
            $('#game-status').text('Arkadaşın bağlandı! Koltuk seçin.');
        });

        peer.on('error', (err) => {
            if(isGuest) {
                conn = peer.connect('syyd-' + roomId);
                setupConn();
            }
        });
    }

    function setupConn() {
        conn.on('data', (data) => {
            if(data.type === 'move') {
                game.move(data.move);
                board.position(game.fen());
                moveSound.play();
            } else if(data.type === 'seat') {
                updateSeatUI(data.role, true);
            }
        });
    }

    function selectSeat(role) {
        myRole = role;
        $('.seat').removeClass('active');
        $(`#seat-${role === 'w' ? 'white' : 'black'}`).addClass('active');
        if(conn) conn.send({type: 'seat', role: role});
    }

    function updateSeatUI(role, occupied) {
        const id = role === 'w' ? '#seat-white' : '#seat-black';
        if(occupied) $(id).addClass('occupied').text('DOLU');
    }

    async function makeAIMove() {
        $('#game-status').text('AI Düşünüyor...');
        const level = $('#ai-level').val();
        try {
            const res = await fetch(`https://stockfish.online/api/s/v2.php?fen=${game.fen()}&depth=${level}`);
            const data = await res.json();
            if(data.success && data.bestmove) {
                const moveParts = data.bestmove.split(' ');
                const move = moveParts[1];
                game.move({ from: move.slice(0,2), to: move.slice(2,4), promotion: 'q' });
                board.position(game.fen());
                moveSound.play();
                $('#game-status').text('Senin Sıran');
            }
        } catch(e) { $('#game-status').text('AI Hatası!'); }
    }

    function onDrop(source, target) {
        if((isAIGame || conn) && game.turn() !== myRole) return 'snapback';

        var move = game.move({ from: source, to: target, promotion: 'q' });
        if (move === null) return 'snapback';

        moveSound.play();
        
        if(conn) conn.send({type: 'move', move: move});
        if(isAIGame) window.setTimeout(makeAIMove, 500);
    }

    function initGame() {
        isAIGame = $('#mode-select').val() === 'ai';
        if(!myRole) { alert('Lütfen bir koltuk seçin!'); return; }

        board = Chessboard('board', {
            draggable: true,
            position: 'start',
            orientation: myRole === 'w' ? 'white' : 'black',
            onDragStart: (s, p) => {
                if (game.game_over()) return false;
                if ((myRole === 'w' && p.search(/^b/) !== -1) || (myRole === 'b' && p.search(/^w/) !== -1)) return false;
            },
            onDrop: onDrop,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });

        $('#setup-section').hide();
        $('#game-status').text(game.turn() === myRole ? 'Senin Sıran' : 'Rakip Bekleniyor...');
        
        if(isAIGame && myRole === 'b') makeAIMove();
    }

    $('#mode-select').on('change', function() {
        if(this.value === 'friend') initPeer();
        $('#ai-levels').toggle(this.value === 'ai');
    });
</script>
</body>
</html>