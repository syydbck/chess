<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syyd Chess_v1.10</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root { --bg: #161512; --panel: #262421; --accent: #45a049; --danger: #b33939; --white: #dee3e6; --black: #8ca2ad; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; }
        
        /* Modals & Overlays */
        #lobby-overlay, #end-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        #end-screen { display: none; z-index: 3000; }
        .card { background: var(--panel); padding: 30px; border-radius: 12px; width: 350px; text-align: center; box-shadow: 0 10px 50px rgba(0,0,0,0.8); }
        
        .main-container { display: none; gap: 15px; padding: 10px; }
        .main-container.active { display: flex; }
        #board { width: 500px; max-width: 90vw; border-radius: 4px; box-shadow: 0 5px 30px rgba(0,0,0,0.6); }

        /* UI Panels */
        .side-panel { width: 340px; height: 500px; display: flex; flex-direction: column; gap: 8px; }
        .box { background: var(--panel); border-radius: 4px; padding: 10px; }
        .flex-grow { flex: 1; overflow-y: auto; background: #1a1917; border-radius: 4px; padding: 8px; font-size: 13px; }
        
        .timer { font-size: 1.8rem; font-family: monospace; background: #1a1917; padding: 2px 10px; border-radius: 4px; border: 1px solid #333; }
        .timer.active { border-color: var(--accent); color: white; box-shadow: 0 0 10px rgba(69,160,73,0.3); }

        #game-status { font-size: 13px; color: var(--accent); font-weight: bold; margin-bottom: 5px; text-align: center; }
        #invite-link-box { font-size: 10px; background: #111; padding: 5px; border-radius: 3px; cursor: pointer; color: var(--accent); margin-top: 5px; border: 1px dashed #444; }

        input, select, button { width: 100%; margin: 5px 0; padding: 12px; border-radius: 6px; border: none; font-family: inherit; box-sizing: border-box; }
        input, select { background: #3d3a37; color: white; border: 1px solid #444; }
        button { background: var(--accent); color: white; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { filter: brightness(1.1); }
        .btn-danger { background: var(--danger); }
        .btn-sec { background: #3d3a37; }
        
        .captured-area { height: 35px; display: flex; align-items: center; gap: 1px; }
        .cap-img { width: 22px; height: 22px; }
        .white-1e1d7 { background-color: var(--white) !important; }
        .black-3b838 { background-color: var(--black) !important; }
    </style>
</head>
<body>

<!-- GİRİŞ EKRANI -->
<div id="lobby-overlay">
    <div class="card">
        <h2 style="color:var(--accent); margin-top:0;">Syyd Chess_v1.10</h2>
        <input type="text" id="p-name" placeholder="Adınız" value="Seyyid">
        <div id="setup-area">
            <select id="p-mode" onchange="$('#ai-ui').toggle(this.value==='ai'); $('#friend-ui').toggle(this.value==='friend');">
                <option value="ai">Bilgisayara Karşı</option>
                <option value="friend" selected>Arkadaşımla Oyna</option>
            </select>
            <div id="ai-ui" style="display:none;"><label style="font-size:11px; color:#888;">AI Zorluğu</label><input type="range" id="ai-lvl" min="1" max="10" value="5"></div>
            <div id="friend-ui"><div style="display:flex; gap:10px;"><div><label style="font-size:11px;">Dakika</label><input type="number" id="t-min" value="5"></div><div><label style="font-size:11px;">Artış</label><input type="number" id="t-inc" value="0"></div></div></div>
            <select id="p-side"><option value="w">Beyaz Ol</option><option value="b">Siyah Ol</option></select>
        </div>
        <button onclick="processStart()">OYUNU BAŞLAT</button>
    </div>
</div>

<!-- OYUN SONU EKRANI -->
<div id="end-screen">
    <div class="card">
        <h1 id="end-title" style="margin-bottom: 5px;">OYUN BİTTİ</h1>
        <p id="end-desc" style="color:#888; margin-bottom: 20px;">Mat ile sonuçlandı.</p>
        <button onclick="location.reload()">YENİ OYUN</button>
    </div>
</div>

<div class="main-container" id="game-ui">
    <div style="width:30px; height:500px; background:#333; position:relative; border-radius:4px; overflow:hidden;"><div id="eval-bar" style="width:100%; height:50%; background:white; position:absolute; bottom:0; transition:1s;"></div></div>
    <div class="board-wrapper">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><span id="opp-tag">Bekleniyor...</span><span id="opp-clock" class="timer">05:00</span></div>
        <div id="cap-top" class="captured-area"></div>
        <div id="board"></div>
        <div id="cap-btm" class="captured-area"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;"><span id="me-tag">Siz</span><span id="me-clock" class="timer">05:00</span></div>
    </div>
    <div class="side-panel">
        <div id="game-status">Bağlantı Bekleniyor...</div>
        <div id="invite-area" style="display:none; margin-bottom:10px;">
            <div style="font-size:11px; color:#888;">Davet Linki (Tıkla Kopyala):</div>
            <div id="invite-link-box" onclick="copyLink()">Linki Kopyala</div>
        </div>
        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <button class="btn-danger" style="padding:5px; font-size:12px;" onclick="resign()">Terk Et</button>
            <button class="btn-sec" style="padding:5px; font-size:12px;" onclick="offerDraw()">Beraberlik</button>
        </div>
        <div class="box flex-grow"><div id="move-list" style="display:grid; grid-template-columns:35px 1fr 1fr; gap:3px;"></div></div>
        <div class="box"><div id="chat-win" style="height:80px; overflow-y:auto; font-size:12px; margin-bottom:5px;"></div><div style="display:flex; gap:5px;"><input type="text" id="chat-in" placeholder="Mesaj..." onkeypress="if(event.key==='Enter') sendChat()"><button onclick="sendChat()" style="width:50px; font-size:11px;">OK</button></div></div>
        <button class="btn-sec" onclick="location.href=location.pathname" style="font-size:11px; padding:5px;">ANA MENÜ</button>
    </div>
</div>

<audio id="snd-move" src="https://images.chesscomfiles.com/chess-themes/sounds/_standard/move-self.mp3"></audio>

<script>
    let board, game = new Chess(), peer, conn, me, side, isAI, clocks = {w:300, b:300}, inc=0, timer;
    let gameActive = false;
    const urlParams = new URLSearchParams(window.location.search);
    const joinId = urlParams.get('room');

    if(joinId) { $('#setup-area').hide(); $('#btn-start').text('OYUNA KATIL'); }

    function processStart() {
        me = $('#p-name').val() || "İsimsiz";
        isAI = joinId ? false : ($('#p-mode').val() === 'ai');
        side = $('#p-side').val();
        clocks.w = clocks.b = ($('#t-min').val() || 5) * 60;
        inc = parseInt($('#t-inc').val()) || 0;
        if(isAI) { setupBoard(); gameActive = true; $('#opp-tag').text("Stockfish Lv" + $('#ai-lvl').val()); startClock(); } 
        else { setupNetwork(); }
    }

    function setupNetwork() {
        if (joinId) {
            peer = new Peer(); peer.on('open', () => { setupBoard(); conn = peer.connect('syyd-' + joinId); conn.on('open', () => conn.send({type: 'join', name: me})); handleConn(); });
        } else {
            const rid = Math.random().toString(36).substring(7);
            peer = new Peer('syyd-' + rid);
            peer.on('open', () => {
                setupBoard();
                const link = window.location.origin + window.location.pathname + '?room=' + rid;
                $('#invite-link-box').attr('data-url', link).text(link);
                $('#invite-area').show();
            });
            peer.on('connection', (c) => { conn = c; handleConn(); });
        }
    }

    function handleConn() {
        conn.on('data', (d) => {
            if(d.type === 'join') {
                $('#opp-tag').text(d.name); $('#game-status').text('Oyun Başladı!'); $('#invite-area').hide();
                conn.send({type:'init', name:me, side:side==='w'?'b':'w', t:clocks.w, inc:inc});
                gameActive = true; startClock();
            } else if(d.type === 'init') {
                side = d.side; clocks.w = clocks.b = d.t; inc = d.inc; $('#opp-tag').text(d.name);
                board.orientation(side === 'w' ? 'white' : 'black'); gameActive = true; $('#game-status').text('Oyun Başladı!'); startClock();
            } else if(d.type === 'move') { game.move(d.move); sync(false); }
            else if(d.type === 'chat') { addMsg(d.name, d.msg); }
            else if(d.type === 'end') { finishGame(d.title, d.desc); }
            else if(d.type === 'draw-offer') { if(confirm('Rakip beraberlik teklif etti. Kabul mü?')) { announceEnd('BERABERE', 'Anlaşma sağlandı.'); conn.send({type:'end', title:'BERABERE', desc:'Anlaşma sağlandı.'}); }}
        });
    }

    function setupBoard() {
        $('#lobby-overlay').fadeOut(); $('#game-ui').addClass('active'); $('#me-tag').text(me);
        board = Chessboard('board', {
            draggable: true, position: 'start', orientation: side==='w'?'white':'black',
            onDragStart: (s, p) => { if (!gameActive || game.game_over()) return false; if ((side==='w' && p.search(/^b/)!==-1) || (side==='b' && p.search(/^w/)!==-1)) return false; },
            onDrop: (s, t) => {
                let move = game.move({ from: s, to: t, promotion: 'q' }); if (!move) return 'snapback';
                sync(true); if(conn) conn.send({type:'move', move:move}); if(isAI) setTimeout(callAI, 600);
            },
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
    }

    function sync(local) {
        board.position(game.fen(), !local); document.getElementById('snd-move').play();
        clocks[local ? side : (side==='w'?'b':'w')] += inc;
        updateUI(); checkStatus();
    }

    async function callAI() {
        if (!isAI || !gameActive) return;
        try {
            const res = await fetch(`https://stockfish.online/api/s/v2.php?fen=${game.fen()}&depth=${$('#ai-lvl').val()}`);
            const d = await res.json();
            if(d.success && d.bestmove) {
                const m = d.bestmove.split(' ')[1]; game.move({ from: m.slice(0,2), to: m.slice(2,4), promotion: 'q' });
                sync(false); if(d.evaluation) { let s = parseFloat(d.evaluation), p = 50 - (s * 5); $('#eval-bar').css('height', Math.max(5, Math.min(95, 100-p)) + '%'); }
            }
        } catch(e) {}
    }

    function checkStatus() {
        if (game.in_checkmate()) {
            let loser = game.turn();
            if (loser === side) announceEnd('KAYBETTİN', 'Mat oldun.');
            else announceEnd('TEBRİKLER, KAZANDIN!', 'Rakibi mat ettin.');
        } else if (game.in_draw()) {
            announceEnd('BERABERE', 'Oyun berabere bitti.');
        }
    }

    function announceEnd(title, desc) {
        if(conn) conn.send({type:'end', title: title==='KAYBETTİN'?'TEBRİKLER, KAZANDIN!':'KAYBETTİN', desc: desc});
        finishGame(title, desc);
    }

    function finishGame(title, desc) {
        gameActive = false; $('#end-title').text(title); $('#end-desc').text(desc);
        if(title.includes('KAZANDIN')) $('#end-title').css('color', 'var(--accent)');
        else if(title.includes('KAYBETTİN')) $('#end-title').css('color', 'var(--danger)');
        $('#end-screen').css('display', 'flex');
    }

    function resign() { if(confirm('Terk etmek istediğine emin misin?')) { announceEnd('KAYBETTİN', 'Terk ettin.'); }}
    function offerDraw() { if(conn) conn.send({type:'draw-offer'}); else alert('AI beraberlik kabul etmiyor!'); }

    function updateUI() {
        let h = game.history(), out = ''; for(let i=0; i<h.length; i+=2) out += `<div>${(i/2)+1}.</div><div>${h[i]}</div><div>${h[i+1]||''}</div>`;
        $('#move-list').html(out);
        const initial = {p:8, n:2, b:2, r:2, q:1}, cur = {w:{p:0,n:0,b:0,r:0,q:0}, b:{p:0,n:0,b:0,r:0,q:0}};
        game.board().flat().filter(p => p).forEach(p => cur[p.color][p.type]++);
        const drawCap = (c) => {
            let res = ''; for(let t in initial) { for(let i=0; i < (initial[t] - cur[c][t]); i++) res += `<img src="https://chessboardjs.com/img/chesspieces/wikipedia/${c.toUpperCase()}${t.toUpperCase()}.png" class="cap-img">`; }
            return res;
        };
        $('#cap-top').html(drawCap(side === 'w' ? 'w' : 'b')); $('#cap-btm').html(drawCap(side === 'w' ? 'b' : 'w'));
    }

    function startClock() {
        clearInterval(timer);
        timer = setInterval(() => {
            if(!gameActive || game.game_over()) return;
            let turn = game.turn(); clocks[turn]--;
            $('#me-clock').text(fmt(clocks[side])).toggleClass('active', turn === side);
            $('#opp-clock').text(fmt(clocks[side==='w'?'b':'w'])).toggleClass('active', turn !== side);
            if(clocks[turn] <= 0) { announceEnd(turn === side ? 'KAYBETTİN' : 'TEBRİKLER, KAZANDIN!', 'Süre doldu.'); }
        }, 1000);
    }

    function fmt(s) { if(s<0) s=0; let m=Math.floor(s/60), sec=s%60; return (m<10?'0':'')+m+":"+(sec<10?'0':'')+sec; }
    function copyLink() { navigator.clipboard.writeText($('#invite-link-box').attr('data-url')); alert('Link Kopyalandı!'); }
    function sendChat() { const m = $('#chat-in').val(); if(!m) return; addMsg('Siz', m); if(conn) conn.send({type:'chat', name:me, msg:m}); $('#chat-in').val(''); }
    function addMsg(u, m) { $('#chat-win').append(`<div><b>${u}:</b> ${m}</div>`).scrollTop(999); }
</script>
</body>
</html>