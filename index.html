<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syyd Chess_v1.2</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root { --bg: #161512; --panel: #262421; --accent: #45a049; --danger: #b33939; --white: #dee3e6; --black: #8ca2ad; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; }
        
        .main-container { display: flex; gap: 15px; padding: 10px; opacity: 0; transition: opacity 0.5s; }
        .main-container.visible { opacity: 1; }

        /* Eval Bar */
        .eval-container { width: 30px; height: 500px; background: #403d39; border-radius: 4px; overflow: hidden; position: relative; }
        #eval-bar { width: 100%; height: 50%; background: white; transition: height 0.7s ease; position: absolute; bottom: 0; }
        #eval-val { position: absolute; width: 100%; text-align: center; top: 5px; font-size: 10px; color: #888; z-index: 5; }

        /* Board Area */
        .board-wrapper { width: 500px; }
        #board { border-radius: 3px; box-shadow: 0 5px 30px rgba(0,0,0,0.6); }

        /* Side Panel */
        .side-panel { width: 340px; height: 500px; display: flex; flex-direction: column; gap: 8px; }
        .box { background: var(--panel); border-radius: 4px; padding: 10px; }
        
        /* Captured Pieces */
        .captured-area { height: 35px; display: flex; align-items: center; flex-wrap: wrap; background: rgba(0,0,0,0.2); margin-bottom: 2px; }
        .captured-piece { width: 22px; height: 22px; }

        /* History & Chat */
        .flex-grow { flex: 1; overflow-y: auto; background: #1a1917; font-size: 13px; border-radius: 4px; padding: 8px; }
        #move-history { display: grid; grid-template-columns: 30px 1fr 1fr; gap: 2px; }
        #chat-msgs { font-size: 12px; height: 80px; overflow-y: auto; margin-bottom: 5px; }
        
        .chat-input-group { display: flex; gap: 5px; }
        #chat-input { flex: 1; background: #3d3a37; border: 1px solid #4d4a46; color: white; padding: 6px; border-radius: 4px; }
        .send-btn { width: 50px; padding: 6px; font-size: 12px; }

        /* Overlay */
        #setup-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .menu-card { background: var(--panel); padding: 30px; border-radius: 12px; width: 360px; box-shadow: 0 10px 50px rgba(0,0,0,0.8); }
        
        input, select, button { width: 100%; margin: 6px 0; padding: 10px; border-radius: 4px; border: none; font-family: inherit; box-sizing: border-box; }
        input, select { background: #3d3a37; color: white; }
        button { background: var(--accent); color: white; cursor: pointer; font-weight: bold; }
        .btn-danger { background: var(--danger); }
        .btn-small { width: 48%; display: inline-block; margin: 2px; font-size: 12px; }
        
        .timer { font-size: 1.8rem; font-family: monospace; background: #1a1917; padding: 2px 10px; border-radius: 4px; border: 1px solid #333; }
        .timer.active { border-color: var(--accent); color: #fff; box-shadow: 0 0 10px rgba(69,160,73,0.3); }

        .white-1e1d7 { background-color: var(--white) !important; }
        .black-3b838 { background-color: var(--black) !important; }
    </style>
</head>
<body>

<div id="setup-overlay">
    <div class="menu-card">
        <h2 style="margin:0 0 15px 0; color:var(--accent); text-align:center;">Syyd Chess_v1.2</h2>
        <input type="text" id="username" placeholder="Adınız" value="Seyyid">
        
        <select id="game-mode" onchange="toggleMode()">
            <option value="ai">Bilgisayara Karşı</option>
            <option value="friend">Arkadaşımla Oyna (Online)</option>
        </select>

        <div id="ai-only">
            <label style="font-size:11px; color:#888;">AI Seviyesi</label>
            <input type="range" id="ai-level" min="1" max="10" value="3">
        </div>

        <div id="friend-only" style="display:none;">
            <div style="display:flex; gap:10px;">
                <div><label style="font-size:11px;">Dakika</label><input type="number" id="base-time" value="5"></div>
                <div><label style="font-size:11px;">Arttırma (sn)</label><input type="number" id="inc-time" value="0"></div>
            </div>
        </div>

        <select id="user-color">
            <option value="w">Beyaz Olarak Başla</option>
            <option value="b">Siyah Olarak Başla</option>
        </select>

        <button id="btn-action" onclick="handleStart()">ODAYI KUR VE BAŞLAT</button>
        <div id="lobby-link" style="font-size: 11px; color: #888; margin-top: 10px; word-break: break-all;"></div>
    </div>
</div>

<div class="main-container" id="ui-main">
    <div class="eval-container">
        <div id="eval-val">0.0</div>
        <div id="eval-bar"></div>
    </div>

    <div class="board-wrapper">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
            <span id="label-opp">Rakip</span>
            <span id="timer-opp" class="timer">05:00</span>
        </div>
        <div id="cap-opp" class="captured-area"></div>
        <div id="board"></div>
        <div id="cap-me" class="captured-area"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
            <span id="label-me">Siz</span>
            <span id="timer-me" class="timer">05:00</span>
        </div>
    </div>

    <div class="side-panel">
        <div class="box" style="display:flex; justify-content:space-between;">
            <button class="btn-danger btn-small" onclick="handleResign()">Terk Et</button>
            <button class="btn-small" style="background:#3d3a37;" onclick="offerDraw()">Beraberlik</button>
        </div>
        <div class="box flex-grow">
            <div style="font-weight:bold; color:var(--accent); font-size:12px; margin-bottom:5px;">HAMLE GEÇMİŞİ</div>
            <div id="move-history"></div>
        </div>
        <div class="box">
            <div id="chat-msgs"></div>
            <div class="chat-input-group">
                <input type="text" id="chat-input" placeholder="Mesaj..." onkeypress="if(event.key==='Enter') sendChat()">
                <button class="send-btn" onclick="sendChat()">Gönder</button>
            </div>
        </div>
        <button style="background:#1a1917; font-size:11px;" onclick="location.href=location.pathname">Ana Menü</button>
    </div>
</div>

<audio id="snd-move" src="https://images.chesscomfiles.com/chess-themes/sounds/_standard/move-self.mp3"></audio>

<script>
    let board, game = new Chess(), peer, conn, myName, mySide, isAI, timers = {w:300, b:300}, inc=0, timerInt;
    const urlParams = new URLSearchParams(window.location.search);
    const roomUrl = urlParams.get('room');

    if(roomUrl) {
        $('#game-mode').val('friend');
        $('#btn-action').text('ODAYA KATIL');
        toggleMode();
    }

    function toggleMode() {
        const mode = $('#game-mode').val();
        $('#ai-only').toggle(mode === 'ai');
        $('#friend-only').toggle(mode === 'friend');
    }

    function handleStart() {
        myName = $('#username').val() || "İsimsiz";
        isAI = $('#game-mode').val() === 'ai';
        mySide = $('#user-color').val();
        timers.w = timers.b = $('#base-time').val() * 60;
        inc = parseInt($('#inc-time').val());

        if(isAI) startMatch(); else setupPeer();
    }

    function setupPeer() {
        const rid = roomUrl || Math.random().toString(36).substring(7);
        peer = new Peer('syyd-' + rid);
        peer.on('open', (id) => {
            if(!roomUrl) {
                const link = window.location.origin + window.location.pathname + '?room=' + rid;
                $('#lobby-link').html("Arkadaşına Gönder:<br><b>" + link + "</b>");
            } else {
                conn = peer.connect('syyd-' + rid);
                bindConn();
            }
        });
        peer.on('connection', (c) => {
            conn = c;
            bindConn();
            setTimeout(() => {
                conn.send({type:'init', name:myName, side:mySide==='w'?'b':'w', t:timers.w, inc:inc});
                startMatch();
            }, 600);
        });
    }

    function bindConn() {
        conn.on('data', (d) => {
            if(d.type === 'init') { mySide = d.side; timers.w = timers.b = d.t; inc = d.inc; $('#label-opp').text(d.name); startMatch(); }
            else if(d.type === 'move') { game.move(d.move); sync(); }
            else if(d.type === 'chat') { addChat(d.name, d.msg); }
            else if(d.type === 'resign') { alert('Rakip terk etti!'); location.reload(); }
            else if(d.type === 'draw') { if(confirm('Rakip beraberlik teklif ediyor, kabul mü?')) { conn.send({type:'chat', name:'Sistem', msg:'Beraberlik kabul edildi.'}); alert('Oyun berabere!'); location.reload(); }}
        });
    }

    function startMatch() {
        $('#setup-overlay').fadeOut();
        $('#ui-main').addClass('visible');
        $('#label-me').text(myName);
        
        board = Chessboard('board', {
            draggable: true, position: 'start', orientation: mySide==='w'?'white':'black',
            onDragStart: (s, p) => {
                if (game.game_over()) return false;
                if ((mySide==='w' && p.search(/^b/)!==-1) || (mySide==='b' && p.search(/^w/)!==-1)) return false;
            },
            onDrop: (s, t) => {
                let move = game.move({ from: s, to: t, promotion: 'q' });
                if (!move) return 'snapback';
                
                // TAŞIN İKİ KERE GİTMESİNİ ENGELLEYEN KRİTİK NOKTA
                // Chessboard.js zaten taşı bırakınca görsel olarak oraya koyar. 
                // Biz burada sadece logic'i (chess.js) güncelliyoruz.
                sync(true); 
                if(conn) conn.send({type:'move', move:move});
                if(isAI) setTimeout(fetchAI, 600);
            },
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });

        startTimer();
        if(isAI && mySide==='b') fetchAI();
    }

    function sync(isLocal = false) {