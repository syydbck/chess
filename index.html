<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syyd Chess_v1.1</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root { --bg: #161512; --panel: #262421; --accent: #45a049; --white: #dee3e6; --black: #8ca2ad; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; }
        
        /* Layout */
        .main-container { display: flex; gap: 15px; padding: 10px; opacity: 0; transition: opacity 0.5s; }
        .main-container.visible { opacity: 1; }

        /* Eval Bar */
        .eval-container { width: 35px; height: 500px; background: #403d39; border-radius: 4px; overflow: hidden; position: relative; }
        #eval-bar { width: 100%; height: 50%; background: white; transition: height 0.7s cubic-bezier(0.4, 0, 0.2, 1); position: absolute; bottom: 0; }
        #eval-val { position: absolute; width: 100%; text-align: center; top: 10px; font-size: 11px; color: #aaa; z-index: 5; font-weight: bold; }

        /* Board Area */
        .board-wrapper { width: 500px; }
        #board { border-radius: 4px; box-shadow: 0 5px 30px rgba(0,0,0,0.6); }

        /* Info Panel */
        .side-panel { width: 320px; height: 500px; display: flex; flex-direction: column; gap: 10px; }
        .box { background: var(--panel); border-radius: 4px; padding: 12px; }
        
        /* Captured Pieces */
        .captured-area { height: 35px; display: flex; gap: 2px; align-items: center; flex-wrap: wrap; }
        .captured-piece { width: 18px; height: 18px; }

        /* History & Chat */
        .flex-grow { flex: 1; overflow-y: auto; background: #1a1917; font-size: 13px; padding: 8px; border-radius: 4px; }
        #move-history { display: grid; grid-template-columns: 30px 1fr 1fr; gap: 4px; }
        #chat-msgs { font-size: 12px; height: 100px; overflow-y: auto; margin-bottom: 8px; border-bottom: 1px solid #333; }

        /* Overlay & Menu */
        #setup-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .menu-card { background: var(--panel); padding: 40px; border-radius: 12px; width: 340px; box-shadow: 0 20px 60px rgba(0,0,0,0.8); }
        
        input, select, button { width: 100%; margin: 10px 0; padding: 12px; border-radius: 6px; border: none; box-sizing: border-box; }
        input, select { background: #3d3a37; color: white; border: 1px solid #4d4a46; }
        button { background: var(--accent); color: white; cursor: pointer; font-weight: bold; font-size: 16px; }
        button:disabled { background: #444; cursor: not-allowed; }
        
        .timer { font-size: 1.8rem; font-family: monospace; background: #1a1917; padding: 5px 10px; border-radius: 4px; }
        .player-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .active-timer { color: #fff; box-shadow: inset 0 0 10px var(--accent); }

        .white-1e1d7 { background-color: var(--white) !important; }
        .black-3b838 { background-color: var(--black) !important; }
    </style>
</head>
<body>

<!-- GİRİŞ EKRANI -->
<div id="setup-overlay">
    <div class="menu-card">
        <h1 style="margin:0 0 20px 0; color:var(--accent);">Syyd Chess_v1.1</h1>
        <input type="text" id="username" placeholder="Adınızı girin" value="Seyyid">
        
        <select id="game-mode">
            <option value="ai">Yapay Zekaya Karşı (Stockfish)</option>
            <option value="friend">Arkadaşımla Oyna (Online)</option>
        </select>

        <div id="ai-settings">
            <label style="font-size: 12px; color: #888;">AI Seviyesi (1: Kolay - 10: Usta)</label>
            <input type="range" id="ai-level" min="1" max="10" value="3">
        </div>

        <select id="user-color">
            <option value="w">Beyaz Olarak Başla</option>
            <option value="b">Siyah Olarak Başla</option>
        </select>

        <button id="main-action-btn" onclick="handleSetup()">ODAYI KUR</button>
        <div id="lobby-status" style="font-size: 12px; color: #aaa; margin-top: 15px; line-height: 1.4;"></div>
    </div>
</div>

<!-- OYUN ALANI -->
<div class="main-container" id="game-ui">
    <div class="eval-container">
        <div id="eval-val">0.0</div>
        <div id="eval-bar"></div>
    </div>

    <div class="board-wrapper">
        <div class="player-row">
            <span id="opp-name">Rakip Bekleniyor...</span>
            <span id="opp-timer" class="timer">05:00</span>
        </div>
        <div id="cap-opp" class="captured-area"></div>
        
        <div id="board"></div>
        
        <div id="cap-me" class="captured-area"></div>
        <div class="player-row">
            <span id="me-name">Siz</span>
            <span id="me-timer" class="timer">05:00</span>
        </div>
    </div>

    <div class="side-panel">
        <div class="box flex-grow">
            <div style="font-weight:bold; color:var(--accent); margin-bottom:8px;">Hamle Geçmişi</div>
            <div id="move-history"></div>
        </div>
        <div class="box chat-panel">
            <div id="chat-msgs"></div>
            <input type="text" id="chat-input" placeholder="Mesaj gönder..." onkeypress="if(event.key==='Enter') sendChat()">
        </div>
        <button style="background:#3d3a37; padding:8px; font-size:12px;" onclick="location.href=location.pathname">Ana Menüye Dön</button>
    </div>
</div>

<audio id="sound-move" src="https://images.chesscomfiles.com/chess-themes/sounds/_standard/move-self.mp3"></audio>

<script>
    let board, game = new Chess(), peer, conn, myName, myColor, isAI, timers = {w:300, b:300}, timerInterval;
    const urlParams = new URLSearchParams(window.location.search);
    const roomFromUrl = urlParams.get('room');

    // Eğer linkle geldiyse modu arkadaş modu yap
    if(roomFromUrl) {
        $('#game-mode').val('friend').attr('disabled', true);
        $('#main-action-btn').text('ODAYA KATIL');
    }

    function handleSetup() {
        myName = $('#username').val() || "İsimsiz";
        isAI = $('#game-mode').val() === 'ai';
        myColor = $('#user-color').val();

        if(isAI) {
            startMatch();
        } else {
            setupMultiplayer();
        }
    }

    function setupMultiplayer() {
        const roomId = roomFromUrl || Math.random().toString(36).substring(7);
        $('#main-action-btn').attr('disabled', true).text('Bağlanıyor...');
        
        peer = new Peer('syyd-' + roomId);
        
        peer.on('open', (id) => {
            if(!roomFromUrl) {
                const link = window.location.origin + window.location.pathname + '?room=' + roomId;
                $('#lobby-status').html(`Arkadaşını Bekle:<br><b style="color:var(--accent); font-size:10px;">${link}</b>`);
            } else {
                conn = peer.connect('syyd-' + roomId);
                initConnEvents();
            }
        });

        peer.on('connection', (c) => {
            conn = c;
            initConnEvents();
            // Ev sahibi olarak, arkadaşım bağlandığında ona ismimi ve ayarlarımı gönderirim
            setTimeout(() => {
                conn.send({type: 'init', name: myName, color: myColor === 'w' ? 'b' : 'w'});
                startMatch();
            }, 500);
        });
    }

    function initConnEvents() {
        conn.on('data', (data) => {
            if(data.type === 'init') {
                myName = $('#username').val();
                myColor = data.color;
                $('#opp-name').text(data.name);
                startMatch();
            } else if(data.type === 'move') {
                game.move(data.move);
                syncGame();
            } else if(data.type === 'chat') {
                logChat(data.sender, data.msg);
            }
        });
    }

    function startMatch() {
        $('#setup-overlay').fadeOut();
        $('#game-ui').addClass('visible');
        $('#me-name').text(myName);
        if(isAI) $('#opp-name').text('Stockfish Seviye ' + $('#ai-level').val());

        board = Chessboard('board', {
            draggable: true,
            position: 'start',
            orientation: myColor === 'w' ? 'white' : 'black',
            onDragStart: (s, p) => {
                if (game.game_over()) return false;
                if ((myColor === 'w' && p.search(/^b/) !== -1) || (myColor === 'b' && p.search(/^w/) !== -1)) return false;
            },
            onDrop: (source, target) => {
                let move = game.move({ from: source, to: target, promotion: 'q' });
                if (!move) return 'snapback';
                
                syncGame();
                if(conn) conn.send({type: 'move', move: move});
                if(isAI) setTimeout(fetchAI, 600);
            },
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });

        startTimers();
        if(isAI && myColor === 'b') fetchAI();
    }

    function syncGame() {
        board.position(game.fen());
        document.getElementById('sound-move').play();
        updateUI();
    }

    async function fetchAI() {
        const level = $('#ai-level').val();
        try {
            const res = await fetch(`https://stockfish.online/api/s/v2.php?fen=${game.fen()}&depth=${level}`);
            const data = await res.json();
            if(data.success && data.bestmove) {
                const m = data.bestmove.split(' ')[1];
                game.move({ from: m.slice(0,2), to: m.slice(2,4), promotion: 'q' });
                syncGame();
                if(data.evaluation) updateEval(data.evaluation);
            }
        } catch(e) { console.error("AI Error"); }
    }

    function updateUI() {
        // Hamle Geçmişi
        let h = game.history(), html = '';
        for(let i=0; i<h.length; i+=2) {
            html += `<div>${(i/2)+1}.</div><div>${h[i]}</div><div>${h[i+1]||''}</div>`;
        }
        $('#move-history').html(html);

        // Yenen Taşlar
        updateCaptured();
    }

    function updateCaptured() {
        const pieces = game.board().flat().filter(p => p);
        const initial = {p:8, n:2, b:2, r:2, q:1};
        const counts = {w:{p:0,n:0,b:0,r:0,q:0}, b:{p:0,n:0,b:0,r:0,q:0}};
        pieces.forEach(p => counts[p.color][p.type]++);

        const getImgs = (color) => {
            let res = '';
            for(let t in initial) {
                let diff = initial[t] - counts[color][t];
                for(let i=0; i<diff; i++) {
                    res += `<img src="https://chessboardjs.com/img/chesspieces/wikipedia/${color.toUpperCase()}${t.toUpperCase()}.png" class="captured-piece">`;
                }
            }
            return res;
        };

        $('#cap-opp').html(getImgs(myColor === 'w' ? 'w' : 'b'));
        $('#cap-me').html(getImgs(myColor === 'w' ? 'b' : 'w'));
    }

    function updateEval(val) {
        let score = parseFloat(val);
        let h = 50 - (score * 5); // Basit oran
        h = Math.max(5, Math.min(95, h));
        $('#eval-bar').css('height', (100-h) + '%');
        $('#eval-val').text(score > 0 ? '+' + score : score);
    }

    function startTimers() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if(game.game_over()) return;
            let turn = game.turn();
            timers[turn]--;
            $('#me-timer').text(formatTime(timers[myColor]));
            $('#opp-timer').text(formatTime(timers[myColor==='w'?'b':'w']));
            
            $('#me-timer').toggleClass('active-timer', turn === myColor);
            $('#opp-timer').toggleClass('active-timer', turn !== myColor);
        }, 1000);
    }

    function formatTime(s) {
        if(s<=0) return "00:00";
        let m = Math.floor(s/60);
        let sec = s%60;
        return (m<10?'0':'')+m+":"+(sec<10?'0':'')+sec;
    }

    function sendChat() {
        const msg = $('#chat-input').val();
        if(!msg || !conn) return;
        conn.send({type:'chat', sender: myName, msg: msg});
        logChat('Siz', msg);
        $('#chat-input').val('');
    }

    function logChat(u, m) {
        $('#chat-msgs').append(`<div><b>${u}:</b> ${m}</div>`).scrollTop(9999);
    }
</script>
</body>
</html>