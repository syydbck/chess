<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syyd Chess_v1.7</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root { --bg: #161512; --panel: #262421; --accent: #45a049; --danger: #b33939; --white: #dee3e6; --black: #8ca2ad; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; }
        
        #lobby-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .setup-card { background: var(--panel); padding: 30px; border-radius: 12px; width: 350px; box-shadow: 0 10px 50px rgba(0,0,0,0.8); }
        
        .main-container { display: none; gap: 15px; padding: 10px; }
        .main-container.active { display: flex; }

        #board { width: 500px; max-width: 90vw; border-radius: 4px; box-shadow: 0 5px 30px rgba(0,0,0,0.6); }

        .side-panel { width: 340px; height: 500px; display: flex; flex-direction: column; gap: 8px; }
        .box { background: var(--panel); border-radius: 4px; padding: 12px; }
        .flex-grow { flex: 1; overflow-y: auto; background: #1a1917; border-radius: 4px; padding: 8px; font-size: 13px; }
        
        .timer { font-size: 1.8rem; font-family: monospace; background: #1a1917; padding: 2px 10px; border-radius: 4px; border: 1px solid #333; }
        .timer.active { border-color: var(--accent); color: white; box-shadow: 0 0 10px rgba(69,160,73,0.3); }

        #invite-box { background: #1a1917; border: 1px dashed var(--accent); padding: 10px; border-radius: 4px; font-size: 11px; margin-bottom: 10px; }
        #invite-link { color: var(--accent); word-break: break-all; cursor: pointer; display: block; margin-top: 5px; }

        #game-status { font-size: 13px; color: var(--accent); font-weight: bold; margin-bottom: 5px; text-align: center; }

        input, select, button { width: 100%; margin: 6px 0; padding: 12px; border-radius: 6px; border: none; font-family: inherit; box-sizing: border-box; }
        input, select { background: #3d3a37; color: white; border: 1px solid #444; }
        button { background: var(--accent); color: white; cursor: pointer; font-weight: bold; }
        .btn-secondary { background: #3d3a37; }

        .captured-area { height: 35px; display: flex; align-items: center; gap: 2px; }
        .cap-img { width: 22px; height: 22px; }
        
        .white-1e1d7 { background-color: var(--white) !important; }
        .black-3b838 { background-color: var(--black) !important; }
    </style>
</head>
<body>

<div id="lobby-overlay">
    <div class="setup-card">
        <h2 style="text-align:center; color:var(--accent); margin-top:0;">Syyd Chess_v1.7</h2>
        <input type="text" id="p-name" placeholder="Adınız" value="Seyyid">
        
        <div id="settings-area">
            <select id="p-mode" onchange="toggleLobby()">
                <option value="ai">Bilgisayara Karşı</option>
                <option value="friend">Arkadaşımla Oyna</option>
            </select>

            <div id="ai-ui">
                <label style="font-size:11px; color:#888;">Stockfish Seviyesi</label>
                <input type="range" id="ai-lvl" min="1" max="10" value="5">
            </div>

            <div id="friend-ui" style="display:none;">
                <div style="display:flex; gap:10px;">
                    <div><label style="font-size:11px;">Dakika</label><input type="number" id="t-min" value="5"></div>
                    <div><label style="font-size:11px;">Artış</label><input type="number" id="t-inc" value="0"></div>
                </div>
            </div>

            <select id="p-side">
                <option value="w">Beyaz Ol</option>
                <option value="b">Siyah Ol</option>
            </select>
        </div>
        
        <button id="btn-start" onclick="processStart()">BAŞLAT</button>
    </div>
</div>

<div class="main-container" id="game-ui">
    <div style="width:30px; height:500px; background:#333; position:relative; border-radius:4px; overflow:hidden;">
        <div id="eval-bar" style="width:100%; height:50%; background:white; position:absolute; bottom:0; transition:0.8s;"></div>
    </div>

    <div class="board-wrapper">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
            <span id="opp-tag">Bekleniyor...</span>
            <span id="opp-clock" class="timer">05:00</span>
        </div>
        <div id="cap-top" class="captured-area"></div>
        <div id="board"></div>
        <div id="cap-btm" class="captured-area"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
            <span id="me-tag">Siz</span>
            <span id="me-clock" class="timer">05:00</span>
        </div>
    </div>

    <div class="side-panel">
        <div id="game-status">Sistem Hazırlanıyor...</div>
        <div id="invite-box" style="display:none;">
            <b>Arkadaşını Davet Et:</b>
            <span id="invite-link" onclick="copyLink()">Linki Kopyalamak İçin Tıkla</span>
        </div>
        <div class="box flex-grow"><div id="move-list" style="display:grid; grid-template-columns:35px 1fr 1fr; gap:5px;"></div></div>
        <div class="box">
            <div id="chat-win" style="height:100px; overflow-y:auto; font-size:12px; margin-bottom:5px;"></div>
            <div style="display:flex; gap:5px;"><input type="text" id="chat-in" placeholder="Mesaj..." onkeypress="if(event.key==='Enter') sendChat()"><button onclick="sendChat()" style="width:60px; font-size:11px;">GÖNDER</button></div>
        </div>
        <button class="btn-secondary" onclick="location.href=location.pathname" style="font-size:11px;">ANA MENÜ</button>
    </div>
</div>

<audio id="snd-move" src="https://images.chesscomfiles.com/chess-themes/sounds/_standard/move-self.mp3"></audio>

<script>
    let board, game = new Chess(), peer, conn, me, side, isAI, clocks = {w:300, b:300}, inc=0, timer;
    let gameActive = false;
    const urlParams = new URLSearchParams(window.location.search);
    const joinId = urlParams.get('room');

    // MİSAFİR AYARI
    if(joinId) {
        $('#settings-area').hide();
        $('#btn-start').text('OYUNA KATIL');
    }

    function toggleLobby() {
        const mode = $('#p-mode').val();
        $('#ai-ui').toggle(mode === 'ai');
        $('#friend-ui').toggle(mode === 'friend');
    }

    function processStart() {
        me = $('#p-name').val() || "İsimsiz";
        
        // KRİTİK DÜZELTME: Eğer linkle geldiyse AI asla olamaz.
        if(joinId) {
            isAI = false;
        } else {
            isAI = $('#p-mode').val() === 'ai';
        }

        side = $('#p-side').val();
        clocks.w = clocks.b = ($('#t-min').val() || 5) * 60;
        inc = parseInt($('#t-inc').val()) || 0;

        if(isAI) {
            setupBoard();
            gameActive = true;
            $('#opp-tag').text("Stockfish Lv" + $('#ai-lvl').val());
            $('#game-status').text('Yapay Zekaya Karşı');
            startClock();
        } else {
            setupNetwork();
        }
    }

    function setupNetwork() {
        const rid = joinId || Math.random().toString(36).substring(7);
        peer = new Peer('syyd-' + rid);
        
        peer.on('open', () => {
            setupBoard();
            if(!joinId) {
                const link = window.location.origin + window.location.pathname + '?room=' + rid;
                $('#invite-link').attr('data-url', link);
                $('#invite-box').show();
                $('#game-status').text('Bağlantı Bekleniyor...');
            } else {
                conn = peer.connect('syyd-' + rid);
                handleConn();
            }
        });

        peer.on('connection', (c) => {
            conn = c;
            handleConn();
            setTimeout(() => {
                conn.send({type:'init', name:me, side:side==='w'?'b':'w', t:clocks.w, inc:inc});
                gameActive = true;
                $('#invite-box').hide();
                $('#game-status').text('Arkadaşın Bağlandı!');
                startClock();
            }, 800);
        });
    }

    function handleConn() {
        conn.on('data', (d) => {
            if(d.type === 'init') { 
                side = d.side; clocks.w = clocks.b = d.t; inc = d.inc; 
                $('#opp-tag').text(d.name);
                board.orientation(side === 'w' ? 'white' : 'black');
                gameActive = true;
                $('#game-status').text('Oyun Başladı!');
                startClock();
            }
            else if(d.type === 'move') { game.move(d.move); sync(false); }
            else if(d.type === 'chat') { addMsg(d.name, d.msg); }
        });
    }

    function setupBoard() {
        $('#lobby-overlay').fadeOut();
        $('#game-ui').addClass('active');
        $('#me-tag').text(me);
        board = Chessboard('board', {
            draggable: true, position: 'start', orientation: side==='w'?'white':'black',
            onDragStart: (s, p) => {
                if (!gameActive || game.game_over()) return false;
                if ((side==='w' && p.search(/^b/)!==-1) || (side==='b' && p.search(/^w/)!==-1)) return false;
            },
            onDrop: (s, t) => {
                let move = game.move({ from: s, to: t, promotion: 'q' });
                if (!move) return 'snapback';
                sync(true);
                if(conn) conn.send({type:'move', move:move});
                if(isAI) setTimeout(callAI, 600);
            },
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
    }

    function sync(local) {
        board.position(game.fen(), !local);
        document.getElementById('snd-move').play();
        clocks[local ? side : (side==='w'?'b':'w')] += inc;
        updateUI();
    }

    async function callAI() {
        // AI GÜVENLİK KİLİDİ: Eğer oyun AI modu değilse asla çalışma.
        if (!isAI) return;

        try {
            const res = await fetch(`https://stockfish.online/api/s/v2.php?fen=${game.fen()}&depth=${$('#ai-lvl').val()}`);
            const d = await res.json();
            if(d.success && d.bestmove) {
                const m = d.bestmove.split(' ')[1];
                game.move({ from: m.slice(0,2), to: m.slice(2,4), promotion: 'q' });
                sync(false);
                if(d.evaluation) {
                    let s = parseFloat(d.evaluation), p = 50 - (s * 5);
                    $('#eval-bar').css('height', Math.max(5, Math.min(95, 100-p)) + '%');
                }
            }
        } catch(e) {}
    }

    function updateUI() {
        let h = game.history(), out = '';
        for(let i=0; i<h.length; i+=2) out += `<div>${(i/2)+1}.</div><div>${h[i]}</div><div>${h[i+1]||''}</div>`;
        $('#move-list').html(out);
        const initial = {p:8, n:2, b:2, r:2, q:1}, cur = {w:{p:0,n:0,b:0,r:0,q:0}, b:{p:0,n:0,b:0,r:0,q:0}};
        game.board().flat().filter(p => p).forEach(p => cur[p.color][p.type]++);
        const drawCap = (c) => {
            let res = '';
            for(let t in initial) {
                for(let i=0; i < (initial[t] - cur[c][t]); i++)
                    res += `<img src="https://chessboardjs.com/img/chesspieces/wikipedia/${c.toUpperCase()}${t.toUpperCase()}.png" class="cap-img">`;
            }
            return res;
        };
        $('#cap-top').html(drawCap(side === 'w' ? 'w' : 'b'));
        $('#cap-btm').html(drawCap(side === 'w' ? 'b' : 'w'));
    }

    function startClock() {
        clearInterval(timer);
        timer = setInterval(() => {
            if(!gameActive || game.game_over()) return;
            let turn = game.turn();
            clocks[turn]--;
            $('#me-clock').text(fmt(clocks[side])).toggleClass('active', turn === side);
            $('#opp-clock').text(fmt(clocks[side==='w'?'b':'w'])).toggleClass('active', turn !== side);
            if(clocks[turn] <= 0) { alert("ZAMAN DOLDU!"); gameActive = false; }
        }, 1000);
    }

    function fmt(s) { if(s<0) s=0; let m=Math.floor(s/60), sec=s%60; return (m<10?'0':'')+m+":"+(sec<10?'0':'')+sec; }
    function copyLink() { navigator.clipboard.writeText($('#invite-link').attr('data-url')); alert('Link Kopyalandı!'); }
    function sendChat() {
        const m = $('#chat-in').val(); if(!m) return;
        addMsg('Siz', m); if(conn) conn.send({type:'chat', name:me, msg:m});
        $('#chat-in').val('');
    }
    function addMsg(u, m) { $('#chat-win').append(`<div><b>${u}:</b> ${m}</div>`).scrollTop(999); }
</script>
</body>
</html>